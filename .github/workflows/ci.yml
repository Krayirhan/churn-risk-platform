# ============================================================================
# ci.yml â€” Continuous Integration Pipeline (GitHub Actions)
# ============================================================================
# NEDEN BU WORKFLOW?
#   Her push ve pull request'te otomatik:
#     1. Lint (flake8) â†’ Kod kalitesi kontrolÃ¼
#     2. Test (pytest) â†’ 98+ testin tamamÄ±nÄ±n geÃ§mesi
#     3. Coverage â†’ Test kapsam raporu
#     4. Docker Build â†’ Image'Ä±n baÅŸarÄ±yla build olmasÄ±
#
# TETÄ°KLENME:
#   - push   â†’ main, develop branch'larÄ±
#   - PR     â†’ main branch'a aÃ§Ä±lan PR'lar
#   - manual â†’ workflow_dispatch ile elle tetikleme
# ============================================================================

name: CI â€” Lint, Test & Build

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch:

# AynÄ± branch'ta birden fazla CI Ã§alÄ±ÅŸÄ±rsa eskisini iptal et
concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

env:
  PYTHON_VERSION: "3.10"
  DOCKER_IMAGE: churn-risk-platform

jobs:

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # JOB 1: Lint â€” Kod kalitesi kontrolÃ¼
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  lint:
    name: ğŸ§¹ Lint (flake8)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Python kurulumu
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: flake8 kurulumu ve Ã§alÄ±ÅŸtÄ±rma
        run: |
          pip install flake8
          # E501: satÄ±r uzunluÄŸu (120 karakter tolerans)
          # W503: line break before binary operator (PEP8 deÄŸiÅŸti)
          # E203: whitespace before ':' (black uyumlu)
          flake8 src/ app.py main.py \
            --max-line-length=120 \
            --extend-ignore=E501,W503,E203,W291,W293,W391 \
            --statistics \
            --count

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # JOB 2: Test â€” pytest + coverage
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  test:
    name: ğŸ§ª Test (pytest)
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Python kurulumu
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: pip

      - name: BaÄŸÄ±mlÄ±lÄ±k kurulumu
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-cov httpx

      - name: Pytest Ã§alÄ±ÅŸtÄ±r (coverage ile)
        run: |
          pytest tests/ \
            -v \
            --tb=short \
            --cov=src \
            --cov=app \
            --cov-report=term-missing \
            --cov-report=xml:coverage.xml \
            --junitxml=test-results.xml

      - name: Test sonuÃ§larÄ±nÄ± yÃ¼kle
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: |
            test-results.xml
            coverage.xml
          retention-days: 30

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # JOB 3: Docker Build â€” Image doÄŸrulamasÄ±
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  docker-build:
    name: ğŸ³ Docker Build
    runs-on: ubuntu-latest
    needs: test
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Docker Buildx kurulumu
        uses: docker/setup-buildx-action@v3

      - name: Docker image build (cache ile)
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: false
          load: true
          tags: ${{ env.DOCKER_IMAGE }}:ci-${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Image boyutunu kontrol et
        run: |
          docker images ${{ env.DOCKER_IMAGE }}:ci-${{ github.sha }}
          echo "---"
          # Image 1GB'dan bÃ¼yÃ¼kse uyar
          SIZE=$(docker images ${{ env.DOCKER_IMAGE }}:ci-${{ github.sha }} --format "{{.Size}}")
          echo "ğŸ“¦ Image size: $SIZE"

      - name: Container smoke test
        run: |
          # Container'Ä± arka planda baÅŸlat
          docker run -d --name smoke-test \
            -p 8000:8000 \
            ${{ env.DOCKER_IMAGE }}:ci-${{ github.sha }}

          # Sunucunun ayaÄŸa kalkmasÄ±nÄ± bekle
          echo "â³ Sunucu baÅŸlatÄ±lÄ±yor..."
          sleep 10

          # Health endpoint kontrolÃ¼
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8000/health || echo "000")
          echo "ğŸ¥ Health check HTTP status: $HTTP_CODE"

          # Temizle
          docker stop smoke-test && docker rm smoke-test

          # 200 veya 503 (model yok ama servis ayakta) kabul edilir
          if [ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "503" ]; then
            echo "âœ… Smoke test passed"
          else
            echo "âŒ Smoke test failed (HTTP $HTTP_CODE)"
            exit 1
          fi
